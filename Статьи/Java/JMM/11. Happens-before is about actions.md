## Happens-before is about actions

  

После того как мы рассмотрели работу happens-before на практике, я бы хотел подробнее остановиться на одном важном моменте. Может кому-то все далее написанное покажется очевидным, но разобраться не помешает.

  

Вы уже достаточно много раз увидели слово "действие" (action) пока читали раздел про happens-before, но скорее всего смысл его не до конца очевиден. Так вот, под "действием" спека имеет в виду результат выполнения выражения в рантайме, а не само статическое выражение в коде (statement). Например, `boolean r1 = initialized;` это всего лишь выражение в программе, но оно может иметь результат: чтение `true` или `false`. Это и есть действие, которое имеет определенный результат во время выполнения. Действия следует рассматривать свободно и абстрактно от различных переупорядочиваний под капотом: просто смотрите на порядок выражений в коде программы, но думайте о том, какой результат может иметь выражение.

  

Теперь следует сказать, что happens-before (и все остальные порядки в JMM) — это именно о *действиях* (actions), которые имеют какой-то результат, а не об абстрактных выражениях в программе.

  

Давайте еще раз взглянем на определение happens-before для треда в изоляции:

  

> If `x` and `y` are *actions* of the same thread and `x` comes before `y` in program order, then `hb(x, y)`.

Как видите, здесь говорится именно о *действиях* (actions): два любых действия в одном и том же треде связаны happens-before, если их соответствующие выражения идут последовательно в порядке программы. Приведу отдельный пример: happens-before существует не между выражениями `x = i` и `int r1 = x`, а между действиями записи `write(x, 5)` и чтением `read(x)`, которое гарантированно обнаружит `5` благодаря установке hb между ними (допустим, что при выполнении `i` имеет значение `5`). Здесь все просто.

  

А вот в случае `volatile` все немного интереснее. Вот определение hb для volatile:

  

> A write to a volatile variable `v` happens-before all *subsequent* reads of `v` by any thread

Обратите внимание на слово *"subsequent"* — это очень важная деталь, которая различает действия и выражения. Определение говорит, что чтение должно *обнаружить* эту запись, чтобы между записью и чтением `volatile` переменной было установлено happens-before отношение. То есть, здесь подразумевается некоторый результат выполнения — это и есть "действие".

  

Именно поэтому даже в случае использования `volatile` *все еще необходимо* делать условие `if (initialized)`, ведь только при обнаружении записи устанавливается отношение `hb` между двумя тредами. То есть, определение happens-before для `volatile` не говорит, что в рантайме чтение всегда увидит `true`, ведь это зависит от шедулера JVM/ОСи и времени пропагации записи другим тредам (eventual visibility). Определение говорит, что *если* запись была обнаружена, то будет установлено отношение hb между тредами. Аналогично следует рассуждать и о мониторе: необходимо обнаружить освобождение монитора, чтобы было установлено hb между тредами.

  

Да, все это звучит банально, но я лишь хотел предостеречеть вас от написания такой программы:

  
```java
public class VolatileNotAlwaysHappensBefore {
   private int x;
   private volatile boolean initialized;

   public void writer() {
      x = 5; /* W1 */
      initialized = true; /* W2 */
   }

   public void reader() {
      boolean r1 = initialized; /* R1 */
      int r2 = x; /* R2, ??? 5 or 0 */
   }
}
```
  

Где вы могли бы неверно рассуждать, что на `R2` всегда прочитаем `5`, ведь типа запись в volatile переменную happens-before чтение из нее, а че бы нет? Но дело в том, что вот так есть hb между тредами:

  
```
write(x, 5) --hb-> write(initialized, true) --hb-> read(initialized):true --hb-> read(x):5
```
  

А вот так нет:

  
```
write(x, 5) --hb-> write(initialized, true) ... read(initialized):false --hb-> read(x):?
```
  

Подводя итог, этим разделом я хотел сказать следующее:

  
1. Happens-before — это о действиях, которые имеют какой-то результат, а не об абстрактных выражениях в программе. Следите внимательно за тем, при каких условиях устанавливается hb, и анализируйте свой случай
2. Для synchronization actions отношение happens-before устанавливается только при обнаружении определенного эффекта памяти. Например, для `volatile` переменной hb устанавливается только после обнаружения записи, а для монитора после обнаружения его освобождения
3. Для действий в одном и том же треде happens-before устанавливается всегда
  

---

  
